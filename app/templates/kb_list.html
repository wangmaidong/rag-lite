{% extends "base.html" %}

{% block title %}知识库管理 - RAG Lite{% endblock %}

{% block content %}
<style>
    @media (min-width: 992px) {
        #kbList>div {
            flex: 0 0 20%;
            max-width: 20%;
        }
    }
</style>
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">首页</a></li>
                <li class="breadcrumb-item active">知识库管理</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-collection"></i> 知识库管理</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createKbModal">
                <i class="bi bi-plus-circle"></i> 创建知识库
            </button>
        </div>
        <!-- 搜索和排序工具栏 -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" action="/kb" id="searchForm" class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label for="searchInput" class="form-label">搜索</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" name="search"
                                placeholder="搜索知识库名称或描述..." value="{{ search }}">
                            {% if search %}
                            <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                                <i class="bi bi-x"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="sortBySelect" class="form-label">排序字段</label>
                        <select class="form-select" id="sortBySelect" name="sort_by" onchange="updateSearch()">
                            <option value="created_at" {% if sort_by=='created_at' %}selected{% endif %}>创建时间</option>
                            <option value="name" {% if sort_by=='name' %}selected{% endif %}>名称</option>
                            <option value="updated_at" {% if sort_by=='updated_at' %}selected{% endif %}>更新时间</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="sortOrderSelect" class="form-label">排序方向</label>
                        <select class="form-select" id="sortOrderSelect" name="sort_order" onchange="updateSearch()">
                            <option value="desc" {% if sort_order=='desc' %}selected{% endif %}>降序</option>
                            <option value="asc" {% if sort_order=='asc' %}selected{% endif %}>升序</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                    </div>
                    <input type="hidden" name="page" value="1">
                    <input type="hidden" name="page_size" value="{{ pagination.page_size if pagination else 10 }}">
                </form>
            </div>
        </div>
        <!-- 知识库列表 -->
        <div class="row" id="kbList">
            {% if kbs %}
            {% for kb in kbs %}
            <div class="col-12 col-sm-6 col-md-4 col-lg mb-4">
                <div class="card h-100">
                    {% if kb.cover_image %}
                    <img src="/kb/{{ kb.id }}/cover" class="card-img-top" alt="{{ kb.name|e }}"
                        style="height: 150px; object-fit: scale-down;">
                    {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                        style="height: 150px;">
                        <i class="bi bi-folder" style="font-size: 3rem; color: #6c757d;"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-folder"></i> {{ kb.name }}
                        </h5>
                        <p class="card-text text-muted small">{{ kb.description or '无描述' }}</p>
                    </div>
                    <div class="card-footer bg-transparent">
                        <button class="btn btn-sm btn-warning" data-kb-id="{{ kb.id }}" data-kb-name="{{ kb.name }}"
                            data-kb-description="{{ kb.description or '' }}" data-kb-chunk-size="{{ kb.chunk_size }}"
                            data-kb-chunk-overlap="{{ kb.chunk_overlap }}"
                            data-kb-cover-image="{{ kb.cover_image or '' }}" onclick="editKbFromButton(this)">
                            <i class="bi bi-pencil"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteKb('{{ kb.id }}', '{{ kb.name }}')">
                            <i class="bi bi-trash"></i> 删除
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 还没有知识库，点击上方按钮创建一个吧！
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 分页控件 -->
        {% if pagination and pagination.total > pagination.page_size %}
        <nav aria-label="知识库列表分页" class="mt-4">
            <ul class="pagination justify-content-center">
                {% set current_page = pagination.page %}
                {% set total_pages = (pagination.total + pagination.page_size - 1) // pagination.page_size %}

                <!-- 上一页 -->
                <li class="page-item {% if current_page <= 1 %}disabled{% endif %}">
                    <a class="page-link"
                        href="?page={{ current_page - 1 }}&page_size={{ pagination.page_size }}{% if search %}&search={{ search|urlencode }}{% endif %}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                        {% if current_page <=1 %}tabindex="-1" aria-disabled="true" {% endif %}>
                        <i class="bi bi-chevron-left"></i> 上一页
                    </a>
                </li>

                <!-- 页码 -->
                {% set start_page = [1, current_page - 2] | max %}
                {% set end_page = [total_pages, current_page + 2] | min %}

                {% if start_page > 1 %}
                <li class="page-item">
                    <a class="page-link"
                        href="?page=1&page_size={{ pagination.page_size }}{% if search %}&search={{ search|urlencode }}{% endif %}&sort_by={{ sort_by }}&sort_order={{ sort_order }}">1</a>
                </li>
                {% if start_page > 2 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
                {% endif %}

                {% for page_num in range(start_page, end_page + 1) %}
                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                    <a class="page-link"
                        href="?page={{ page_num }}&page_size={{ pagination.page_size }}{% if search %}&search={{ search|urlencode }}{% endif %}&sort_by={{ sort_by }}&sort_order={{ sort_order }}">
                        {{ page_num }}
                    </a>
                </li>
                {% endfor %}

                {% if end_page < total_pages %} {% if end_page < total_pages - 1 %} <li class="page-item disabled">
                    <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ total_pages }}&page_size={{ pagination.page_size }}{% if search %}&search={{ search|urlencode }}{% endif %}&sort_by={{ sort_by }}&sort_order={{ sort_order }}">{{
                            total_pages }}</a>
                    </li>
                    {% endif %}

                    <!-- 下一页 -->
                    <li class="page-item {% if current_page >= total_pages %}disabled{% endif %}">
                        <a class="page-link"
                            href="?page={{ current_page + 1 }}&page_size={{ pagination.page_size }}{% if search %}&search={{ search|urlencode }}{% endif %}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                            {% if current_page>= total_pages %}tabindex="-1" aria-disabled="true"{% endif %}>
                            下一页 <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
            </ul>
            <div class="text-center text-muted small mt-2">
                共 {{ pagination.total }} 个知识库{% if search %}（搜索: "{{ search }}"）{% endif %}，第 {{ current_page }} / {{
                total_pages }} 页
            </div>
        </nav>
        {% endif %}
    </div>
</div>
<!-- 创建知识库模态框 -->
<div class="modal fade" id="createKbModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建知识库</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createKbForm" onsubmit="createKb(event)" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">封面图片（可选）</label>
                        <input type="file" class="form-control" name="cover_image"
                            accept="image/jpeg,image/png,image/gif,image/webp" id="coverImageInput">
                        <div class="form-text">支持 JPG、PNG、GIF、WEBP 格式，最大 5MB</div>
                        <div id="coverImagePreview" class="mt-2" style="display: none;">
                            <img id="coverPreviewImg" src="" alt="封面预览" class="img-thumbnail"
                                style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">分块大小</label>
                            <input type="number" class="form-control" name="chunk_size" value="512" min="100"
                                max="2000">
                            <div class="form-text">每个文本块的最大字符数，建议 512-1024</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">分块重叠</label>
                            <input type="number" class="form-control" name="chunk_overlap" value="50" min="0" max="200">
                            <div class="form-text">相邻块之间的重叠字符数，建议 50-100</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">创建</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 编辑知识库模态框 -->
<div class="modal fade" id="editKbModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑知识库</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editKbForm" onsubmit="updateKb(event)" enctype="multipart/form-data">
                <input type="hidden" name="kb_id" id="editKbId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" id="editKbName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <textarea class="form-control" name="description" id="editKbDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">封面图片</label>
                        <div id="editCoverPreview" class="mb-2">
                            <img id="editCoverPreviewImg" src="" alt="当前封面" class="img-thumbnail"
                                style="max-width: 200px; max-height: 200px; display: none;">
                            <div id="editCoverNoImage" class="text-muted small" style="display: none;">暂无封面</div>
                        </div>
                        <input type="file" class="form-control" name="cover_image"
                            accept="image/jpeg,image/png,image/gif,image/webp" id="editCoverImageInput">
                        <div class="form-text">支持 JPG、PNG、GIF、WEBP 格式，最大 5MB。留空则不修改封面。</div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="delete_cover" id="editDeleteCover"
                                value="true">
                            <label class="form-check-label" for="editDeleteCover">
                                删除封面图片
                            </label>
                        </div>
                        <div id="editCoverNewPreview" class="mt-2" style="display: none;">
                            <img id="editCoverNewPreviewImg" src="" alt="新封面预览" class="img-thumbnail"
                                style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">分块大小</label>
                            <input type="number" class="form-control" name="chunk_size" id="editKbChunkSize" value="512"
                                min="100" max="2000">
                            <div class="form-text">每个文本块的最大字符数，建议 512-1024</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">分块重叠</label>
                            <input type="number" class="form-control" name="chunk_overlap" id="editKbChunkOverlap"
                                value="50" min="0" max="200">
                            <div class="form-text">相邻块之间的重叠字符数，建议 50-100</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function createKb(event) {
        event.preventDefault()
        const form = event.target
        const formData = new FormData(form)
        try {
            const response = await fetch('/api/v1/kb', {
                method: 'POST',
                body: formData//使用FormData的时候不需要再手工指定Content-Type，因为浏览器会自动设置内容类型
            })
            if (response.ok) {
                location.reload()
            } else {
                const error = await response.json();
                alert("创建知识库失败: " + error.message)
            }
        } catch (error) {
            alert("创建知识库失败:" + error.message)
        }
    }
    async function deleteKb(kbId, kbName) {
        if (!confirm(`确定要删除知识库 "${kbName}" 吗？此操作不可恢复!  `)) {
            return
        }
        try {
            const response = await fetch(`/api/v1/kb/${kbId}`, {
                method: 'DELETE'
            })
            if (response.ok) {
                location.reload()
            } else {
                const error = await response.json();
                alert("删除知识库失败: " + error.message)
            }
        } catch (error) {
            alert("删除知识库失败:" + error.message)
        }
    }
    function editKbFromButton(button) {
        const kbId = button.getAttribute('data-kb-id')
        const name = button.getAttribute('data-kb-name')
        const description = button.getAttribute('data-kb-description')
        const chunkSize = button.getAttribute('data-kb-chunk-size')
        const chunkOverlap = button.getAttribute('data-kb-chunk-overlap')
        const coverImage = button.getAttribute('data-kb-cover-image') || ''
        editKb(kbId, name, description, chunkSize, chunkOverlap, coverImage)
    }
    function editKb(kbId, name, description, chunkSize, chunkOverlap, coverImage) {
        document.getElementById('editKbId').value = kbId
        document.getElementById('editKbName').value = name
        document.getElementById('editKbDescription').value = description
        document.getElementById('editKbChunkSize').value = chunkSize
        document.getElementById('editKbChunkOverlap').value = chunkOverlap
        document.getElementById('editDeleteCover').checked = false
        document.getElementById('editCoverImageInput').value = ''

        const previewImg = document.getElementById('editCoverPreviewImg')
        const noImageDiv = document.getElementById('editCoverNoImage')
        const newPreivew = document.getElementById('editCoverNewPreview')
        const newPreivewImg = document.getElementById('editCoverNewPreviewImg')

        if (newPreivew) {
            newPreivew.style.display = 'none'
        }
        if (newPreivewImg) {
            newPreivewImg.src = ""
        }
        if (coverImage) {
            previewImg.src = `/kb/${kbId}/cover`
            previewImg.style.display = 'block'
            noImageDiv.style.display = 'none'
        } else {
            previewImg.style.display = 'none'
            noImageDiv.style.display = 'block'
        }


        const modal = new bootstrap.Modal(document.getElementById('editKbModal'))
        modal.show()
    }
    async function updateKb(event) {
        event.preventDefault()
        const form = event.target
        const formData = new FormData(form)
        const kbId = formData.get('kb_id')
        try {
            const response = await fetch(`/api/v1/kb/${kbId}`, {
                method: 'PUT',
                body: formData//使用FormData的时候不需要再手工指定Content-Type，因为浏览器会自动设置内容类型
            })
            if (response.ok) {
                location.reload()
            } else {
                const error = await response.json();
                alert("更新知识库失败: " + error.message)
            }
        } catch (error) {
            alert("更新知识库失败:" + error.message)
        }
    }
    document.getElementById("coverImageInput")?.addEventListener('change', function (e) {
        const file = e.target.files[0]
        const preview = document.getElementById('coverImagePreview')
        const previewImg = document.getElementById('coverPreviewImg')
        if (file) {
            const reader = new FileReader()
            reader.onload = function (e) {
                previewImg.src = e.target.result
                preview.style.display = 'block'
            }
            reader.readAsDataURL(file)
        } else {
            preview.style.display = 'none'
        }
    })
    document.getElementById("editCoverImageInput")?.addEventListener('change', function (e) {
        const file = e.target.files[0]
        const newPreview = document.getElementById('editCoverNewPreview')
        const newPreviewImg = document.getElementById('editCoverNewPreviewImg')
        const deleteCheckbox = document.getElementById('editDeleteCover')
        if (file) {
            const reader = new FileReader()
            reader.onload = function (e) {
                newPreviewImg.src = e.target.result
                newPreview.style.display = 'block'
                //当选择新的图片的时候让删除图片的复选框自动取消选择
                if (deleteCheckbox) {
                    deleteCheckbox.checked = false
                }
            }
            reader.readAsDataURL(file)
        } else {
            newPreview.style.display = 'none'
        }
    })
    document.getElementById("editDeleteCover")?.addEventListener('change', function (e) {
        const fileInput = document.getElementById("editCoverImageInput")
        const newPreview = document.getElementById('editCoverNewPreview')
        if (e.target.checked) {
            fileInput.value = ''
            newPreview.style.display = 'none'
        }
    })

    function updateSearch(){
        document.getElementById('searchForm').submit()
    }
    function clearSearch(){
        document.getElementById('searchInput').value =''
        //移除搜索参数，保留排序参数
        const url = new URL(window.location.href)
        url.searchParams.delete('search')
        url.searchParams.set('page',1)
        window.location.href = url.toString()
    }
    document.getElementById('searchInput')?.addEventListener('keypress',function(){
        if (e.key === 'Enter'){
            e.preventDefault()
            updateSearch()
        }
    })
</script>
{% endblock %}